<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fintech QC Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
         :root {
            /* Graphite Theme */
            --bg-color: #e5e5ea;
            --text-color: #1c1c1e;
            --text-muted-color: #3a3a3c;
            --card-bg: rgba(242, 242, 247, 0.85);
            --card-border: rgba(0, 0, 0, 0.08);
            --header-bg: rgba(235, 235, 240, 0.85);
            --header-border: rgba(0, 0, 0, 0.09);
            --sub-box-bg: rgba(229, 229, 234, 0.8);
            --accent-color: #5856d6; /* iOS Purple */
            --button-text: #000000;
            --button-bg: #ffffff;
            --button-border: rgba(0, 0, 0, 0.08);
            --button-hover-bg: rgba(0, 0, 0, 0.04);
            --button-disabled-bg: #f2f2f7;
            --button-disabled-text: #aeaeb2;
            --button-disabled-border: #d1d5db;
            --good-tint: rgba(48, 209, 88, 0.15);
            --medium-tint: rgba(255, 159, 10, 0.15);
            --bad-tint: rgba(255, 69, 58, 0.15);
             --good-text: #1a8a4d;
             --medium-text: #b45309;
             --bad-text: #c53030;
            --spinner-color: var(--accent-color);
            --header-height: 64px;
        }
        html {
            scroll-behavior: smooth;
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-top: var(--header-height);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            transition: padding-top 0.3s ease;
         }
         body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: transparent; }
        body::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; }

        .hidden { display: none; }
        .fa-sync-alt.animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

         /* Glassy Sticky Header */
        #appHeader {
            position: sticky; top: 0; left: 0; right: 0; z-index: 50;
            background-color: var(--header-bg);
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--header-border);
            height: var(--header-height); padding: 0 1rem; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
        }
         @media (min-width: 768px) { #appHeader { padding: 0 2rem; } }

         /* Main content container */
         #appContainer {
             flex-grow: 1;
             display: flex;
             flex-direction: column;
             width: 100%; max-width: 1152px; /* max-w-6xl */
             margin-left: auto; margin-right: auto;
             padding-left: 1rem; padding-right: 1rem; padding-bottom: 2rem;
             opacity: 0; transition: opacity 0.5s ease, max-width 0.3s ease, padding 0.3s ease;
             min-height: 0;
             overflow-y: auto;
         }
          @media (min-width: 768px) { #appContainer { padding-left: 2rem; padding-right: 2rem;} }

        .metric-card, .sub-box {
            border-radius: 1.5rem; transition: all 0.3s ease;
            border: 1px solid var(--card-border); background-color: var(--card-bg);
            backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }
        .page-content {
             padding-top: 1.5rem;
             padding-bottom: 0;
             flex-grow: 1;
             display: flex; flex-direction: column;
             min-height: 0;
             min-height: calc(100vh - var(--header-height) - 2rem);
         }

        /* Accordion Styles */
        .book-card {
             background: var(--card-bg); border: 1px solid var(--card-border);
             border-radius: 1.5rem; margin-bottom: 1.5rem;
             box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06); overflow: hidden;
             flex-shrink: 0;
        }
        .book-header, .module-header {
            padding: 1rem 1.5rem; cursor: pointer; transition: background-color 0.2s ease;
            display: flex; justify-content: space-between; align-items: center;
        }
        /* --- NEW: Style for locked book header --- */
        .book-header[data-locked="true"] {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .book-header[data-locked="true"]:hover {
            background-color: transparent;
        }
        .book-header[data-passcode-protected="true"] {
            cursor: pointer; /* Override not-allowed for the header itself */
        }
        
        .book-header { border-bottom: 1px solid var(--card-border); }
        .book-header:not([data-locked="true"]):hover, .module-header:hover { 
            background-color: var(--button-hover-bg); 
        }
        
        .book-title, .module-title { font-size: 1.1rem; font-weight: 600; color: var(--text-color); }
        .book-title-wrapper { display: flex; align-items: center; gap: 0.75rem; }
        .lock-icon {
            color: var(--text-muted-color);
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }
        .lock-icon.unlocked {
            color: var(--good-text);
        }

        .chevron { transition: transform 0.3s ease; color: var(--text-muted-color); }
        .rotate-180 { transform: rotate(180deg); }
        .book-content, .module-content {
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0; overflow: hidden; background-color: var(--sub-box-bg); padding: 0 1rem;
        }
        /* --- NEW: Style for locked book content --- */
        .book-content[data-locked="true"] {
            pointer-events: none;
            user-select: none;
        }
        .book-content.open, .module-content.open { max-height: 10000px; padding: 1rem; }
        .module-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 1rem; margin-bottom: 1rem; overflow: hidden;
        }

        /* Table Styles */
        .chapter-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .chapter-table th, .chapter-table td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid var(--card-border); font-size: 0.875rem; }
        .chapter-table th { background-color: transparent; color: var(--text-muted-color); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; border-bottom-width: 1px; }
        .chapter-table tbody tr { transition: background-color 0.15s ease-in-out; }
        .chapter-table tbody tr:hover { background-color: var(--button-hover-bg); }
        .chapter-table td:first-child { border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; }
        .chapter-table td:last-child { border-top-right-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }
         .chapter-table tbody tr:last-child td { border-bottom: none; }
        .status-pill { font-size: 0.7rem; font-weight: 700; padding: 0.2rem 0.6rem; border-radius: 99px; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-done { background-color: var(--good-tint); color: var(--good-text); border: 1px solid var(--good-text); }
        .status-pending { background-color: rgba(0,0,0,0.05); color: var(--text-muted-color); border: 1px solid rgba(0,0,0,0.1); }
        .view-report-button {
             font-weight: 600; padding: 0.4rem 0.8rem; border-radius: 0.5rem; transition: all 0.2s ease; cursor: pointer;
             display: inline-flex; align-items: center; justify-content: center; border: 1px solid transparent;
             background-color: var(--accent-color); color: white; font-size: 0.75rem;
             box-shadow: 0 2px 8px rgba(88, 86, 214, 0.15);
        }
        .view-report-button:hover:not(:disabled) { background-color: #4341a4; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(88, 86, 214, 0.2); }
        .no-report-span { background-color: #e5e7eb; color: #4b5563; font-size: 0.75rem; font-weight: 600; padding: 0.4rem 0.8rem; border-radius: 0.5rem; cursor: not-allowed; display: inline-block; }

        #appFooter { display: none !important; }
        #page-report-viewer.active ~ #appFooter { display: none; }

        /* Report Viewer Styles */
        .page { display: none; }
        .page.active { display: block; flex-grow: 1; display: flex; flex-direction: column; }
         #page-report-viewer {
             padding-top: 0;
             flex-grow: 1;
             display: flex;
             flex-direction: column;
         }
         #page-report-viewer > .report-viewer-inner-container {
              flex-grow: 1;
              min-height: 0;
              display: flex;
              flex-direction: column;
         }
        .report-viewer-header {
             display: flex; align-items: center;
             justify-content: space-between;
             padding: 0.5rem 1rem;
             flex-shrink: 0;
             height: auto;
             box-sizing: border-box;
             position: relative;
         }
         #page-report-viewer .report-viewer-header h2 {
             position: absolute;
             left: 50%;
             transform: translateX(-50%);
             max-width: calc(100% - 100px);
             text-align: center;
         }

        .report-iframe-wrapper {
            flex-grow: 1; border-radius: 1rem; overflow: hidden;
            background-color: #fff; border: 1px solid var(--card-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
            position: relative;
            min-height: 0;
            transition: all 0.3s ease;
        }
        .report-iframe-wrapper .iframe-loader {
             position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
             background-color: #fff; z-index: 10;
        }
        .report-iframe { width: 100%; height: 100%; border: none; }

        #appContainer:has(#page-report-viewer.active) {
            max-width: none;
            padding-left: 0;
            padding-right: 0;
            padding-bottom: 0;
            overflow: hidden;
        }
        #appContainer:has(#page-report-viewer.active) .report-iframe-wrapper {
            border-radius: 0;
            border: none;
            box-shadow: none;
        }
        @media (min-width: 768px) {
            #appContainer:has(#page-report-viewer.active) .report-viewer-header {
                 padding-left: 2rem;
                 padding-right: 2rem;
            }
        }

         /* Glassy Button Styles */
         .glassy-button {
             background-color: var(--button-bg); color: var(--text-color); border: 1px solid var(--button-border);
             box-shadow: 0 1px 2px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.7);
             background-image: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0.1));
             font-weight: 600; padding: 0.6rem 1rem; border-radius: 9999px;
             transition: all 0.15s ease-out; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
             height: 40px; box-sizing: border-box; user-select: none; -webkit-user-select: none;
             width: 40px; padding: 0;
        }
        .glassy-button.with-text {
             width: auto; padding: 0.6rem 1rem;
        }
        .glassy-button.primary {
            background-color: var(--accent-color);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(88, 86, 214, 0.25);
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.15), rgba(255,255,255,0));
        }
        .glassy-button.primary:hover:not(:disabled) {
            background-color: #4341a4;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 86, 214, 0.3);
            border-color: transparent;
        }
        
        .glassy-button:hover:not(:disabled) {
             background-color: var(--button-hover-bg); border-color: rgba(0,0,0,0.1);
             transform: translateY(-1px);
             box-shadow: 0 3px 6px rgba(0,0,0,0.07), inset 0 1px 1px rgba(255,255,255,0.6);
        }
         .glassy-button:active:not(:disabled) {
             transform: translateY(0px);
             box-shadow: 0 1px 1px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.7);
             background-color: rgba(0,0,0,0.03);
             transition-duration: 0.05s;
         }
        .glassy-button:disabled {
             background-color: var(--button-disabled-bg); color: var(--button-disabled-text); border-color: var(--button-disabled-border);
             box-shadow: none; background-image: none; cursor: not-allowed; opacity: 0.7;
        }
        .glassy-button .spinner { display: none; width: 1em; height: 1em; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 0.5rem; }
        .glassy-button:disabled .spinner { display: inline-block; color: var(--button-disabled-text);}
        .back-button i { margin: 0; font-size: 1.1rem; }
        .refresh-btn i { margin: 0; font-size: 1.1rem; }

        .full-page-loader { display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; background-color: var(--bg-color); position: fixed; inset: 0; z-index: 2000; transition: opacity 0.5s ease-in-out; opacity: 1; pointer-events: auto; }
        .full-page-loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 1s linear infinite; }

        /* --- NEW: Passcode Modal Styles --- */
        #passcode-modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        #passcode-modal-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #passcode-modal {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1.5rem;
            box-shadow: 0 25px 60px -15px rgba(0,0,0,.25);
            padding: 2rem;
            width: 100%;
            max-width: 380px;
            margin: 1rem;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        #passcode-modal-backdrop.visible #passcode-modal {
            transform: scale(1);
        }
        #passcode-modal h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-color);
            text-align: center;
            margin-bottom: 0.5rem;
        }
        #passcode-modal p {
            font-size: 0.9rem;
            color: var(--text-muted-color);
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #passcode-input {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--button-disabled-border);
            background-color: var(--button-bg);
            text-align: center;
            letter-spacing: 0.5em;
            font-weight: 600;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.04);
        }
        #passcode-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.04), 0 0 0 3px rgba(88, 86, 214, 0.2);
        }
        #passcode-error {
            color: var(--bad-text);
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            min-height: 1.2em;
            margin-top: 0.75rem;
        }
        #passcode-modal-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        #passcode-modal-buttons button {
            flex: 1;
        }
        /* --- NEW: Shake animation for error --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-modal {
            animation: shake 0.5s ease-in-out;
        }
        /* --- End Passcode Modal Styles --- */


    </style>
</head>
<body>

    <!-- Updated Full Page Loader -->
    <div id="pageLoader" class="full-page-loader">
        <div id="loading-text-container">
            <span>Loading Dashboard...</span>
        </div>
    </div>

    <!-- Sticky Header -->
    <header id="appHeader" class="flex items-center justify-between">
         <!-- Greeting/Left element container -->
        <div class="flex items-center">
            <span class="text-sm font-medium text-gray-500 mr-4 hidden sm:inline">Welcome!</span>
        </div>
        <!-- Centered Title -->
        <h1 class="text-xl md:text-2xl font-bold text-gray-900 absolute left-1/2 transform -translate-x-1/2">
            Fintech QC Dashboard
        </h1>
         <!-- Refresh Button (Right) -->
        <button id="refresh-button" class="refresh-btn glassy-button z-10">
            <i class="fas fa-sync-alt"></i>
            <span class="spinner"></span>
        </button>
    </header>

    <!-- Main Content Area -->
    <div id="appContainer" class="flex flex-col flex-grow">
        <!-- Error State -->
        <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-4 rounded-lg relative my-6 hidden flex-shrink-0" role="alert">
            <strong class="font-bold">Error: </strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <!-- PAGE 1: Main Dashboard List -->
        <div id="page-dashboard" class="page active page-content">
            <div id="dashboard-content" class="space-y-6 flex-grow">
                <div class="text-center p-12 text-gray-500">Building dashboard...</div>
            </div>
        </div>

        <!-- PAGE 2: Report Viewer -->
        <div id="page-report-viewer" class="page page-content" style="display: none;">
            <div class="report-viewer-inner-container flex flex-col flex-grow" style="min-height: 0;">
                <!-- Header with Back Button and Centered Title -->
                <div class="report-viewer-header flex-shrink-0 relative">
                    <button id="back-to-dashboard-button" class="back-button glassy-button z-10">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 id="report-title" class="text-xl font-semibold text-gray-700 truncate">
                        Loading Report...
                    </h2>
                </div>

                <!-- Iframe Wrapper -->
                <div id="iframe-wrapper" class="report-iframe-wrapper">
                    <div class="iframe-loader text-center p-12">
                        <div class="spinner border-[var(--card-border)] border-t-[var(--accent-color)] w-12 h-12 animate-spin mx-auto"></div>
                        <p class="mt-4 text-[var(--text-muted-color)]">Loading report content...</p>
                    </div>
                    <iframe id="report-iframe" class="report-iframe hidden" src="about:blank"
                            sandbox="allow-scripts allow-same-origin allow-popups allow-forms">
                    </iframe>
                </div>
            </div>
        </div>

    </div>
    
    <!-- --- NEW: Passcode Modal HTML --- -->
    <div id="passcode-modal-backdrop">
        <div id="passcode-modal" role="dialog" aria-modal="true" aria-labelledby="passcode-title">
            <h3 id="passcode-title">Enter Passcode</h3>
            <p id="passcode-book-name">For Book: "..."</p>
            <input type="password" id="passcode-input" placeholder="••••" maxlength="4" inputmode="numeric">
            <div id="passcode-error"></div>
            <div id="passcode-modal-buttons">
                <button id="passcode-cancel-button" class="glassy-button with-text">Cancel</button>
                <button id="passcode-submit-button" class="glassy-button with-text primary">Unlock</button>
            </div>
        </div>
    </div>
    <!-- --- End Passcode Modal HTML --- -->


    <script>
        // --- Configuration ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxP0LkTYhkky8p2w0dOmmCIj01aYnurgT2JBV00Pp6kWlY-j-g8JdXAldyvAIqkddw/exec";

        // --- DOM Elements ---
        const pageLoader = document.getElementById('pageLoader');
        const appHeader = document.getElementById('appHeader');
        const appContainer = document.getElementById('appContainer');
        const pageDashboard = document.getElementById('page-dashboard');
        const pageReportViewer = document.getElementById('page-report-viewer');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const dashboardContent = document.getElementById('dashboard-content');
        const refreshButton = document.getElementById('refresh-button');
        const refreshSpinner = refreshButton.querySelector('.spinner');
        const backToDashboardButton = document.getElementById('back-to-dashboard-button');
        const reportTitle = document.getElementById('report-title');
        const iframeWrapper = document.getElementById('iframe-wrapper');
        const iframeLoader = iframeWrapper.querySelector('.iframe-loader');
        const reportIframe = document.getElementById('report-iframe');
        
        // --- NEW: Passcode Modal DOM Elements ---
        const passcodeModalBackdrop = document.getElementById('passcode-modal-backdrop');
        const passcodeModal = document.getElementById('passcode-modal');
        const passcodeBookName = document.getElementById('passcode-book-name');
        const passcodeError = document.getElementById('passcode-error');
        const passcodeSubmitButton = document.getElementById('passcode-submit-button');
        const passcodeCancelButton = document.getElementById('passcode-cancel-button');
        const passcodeInput = document.getElementById('passcode-input');

        let bookStructure = [];
        let qcSummaries = {};
        
        // --- NEW: State for passcode modal ---
        let currentBookToUnlock = null; // Will store { bookName, targetId, headerElement }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
             if (WEB_APP_URL.includes("PASTE_YOUR_DEPLOYED_WEB_APP_URL_HERE")) {
                showError("Configuration Error: WEB_APP_URL is not set. Please edit this file.");
                hideLoader();
                return;
            }
            loadData(false);
            
            // --- NEW: Passcode Modal Event Listeners ---
            passcodeCancelButton.addEventListener('click', hidePasscodeModal);
            passcodeSubmitButton.addEventListener('click', handleSubmitPasscode);
            // Allow pressing Enter to submit
            passcodeInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleSubmitPasscode();
                }
            });
            // Close modal if clicking backdrop
            passcodeModalBackdrop.addEventListener('click', (e) => {
                if (e.target === passcodeModalBackdrop) {
                    hidePasscodeModal();
                }
            });
        });

        refreshButton.addEventListener('click', () => loadData(true));
        backToDashboardButton.addEventListener('click', showDashboardPage);

        // --- Page Navigation ---
        function showDashboardPage() {
            pageReportViewer.style.display = 'none';
             pageReportViewer.classList.remove('active');
            pageDashboard.style.display = 'block';
             pageDashboard.classList.add('active');
            appHeader.style.display = 'flex';
            document.body.style.paddingTop = 'var(--header-height)';
            reportIframe.removeEventListener('load', handleIframeLoad);
            reportIframe.srcdoc = '';
            reportIframe.src = 'about:blank';
            reportIframe.classList.add('hidden');
            iframeLoader.style.display = 'flex';
        }

        // --- Helper to Decode HTML Entities ---
        function decodeHtmlEntities(text) {
             if (typeof text !== 'string') return '';
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        // --- Iframe Load Handler ---
        function handleIframeLoad() {
            setTimeout(() => {
                try {
                    const iframeWin = reportIframe.contentWindow;
                    const iframeDoc = reportIframe.contentDocument || iframeWin?.document;
                    if (!iframeDoc) {
                        console.error("Could not access iframe document.");
                        return;
                    }
                    const internalLinks = iframeDoc.querySelectorAll('a[href^="#"]');
                    internalLinks.forEach(link => {
                        link.addEventListener('click', (event) => {
                            event.preventDefault();
                            event.stopPropagation();
                            const href = link.getAttribute('href');
                            if (href && href.length > 1) {
                                const targetId = href.substring(1);
                                const targetElement = iframeDoc.getElementById(targetId);
                                if (targetElement) {
                                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                 }
                            }
                        }, false);
                    });
                    iframeLoader.style.display = 'none';
                    reportIframe.classList.remove('hidden');
                } catch (error) {
                    console.error("Error setting up iframe navigation:", error);
                    iframeLoader.innerHTML = `<div class="p-4 text-center"><p class="text-red-500 font-bold">Error initializing report view: ${error.message}</p></div>`;
                    reportIframe.classList.add('hidden');
                }
            }, 100);
        }

        function showReportPage(fileId, title) {
            pageDashboard.style.display = 'none';
             pageDashboard.classList.remove('active');
            pageReportViewer.style.display = 'flex';
             pageReportViewer.classList.add('active');
            appHeader.style.display = 'none';
            document.body.style.paddingTop = '0';

            const decodedTitle = decodeHtmlEntities(title);
            reportTitle.textContent = `Report: ${decodedTitle}`;

            iframeLoader.style.display = 'flex';
            iframeLoader.innerHTML = ` <div class="text-center p-12">
                                        <div class="spinner border-[var(--card-border)] border-t-[var(--accent-color)] w-12 h-12 animate-spin mx-auto"></div>
                                        <p class="mt-4 text-[var(--text-muted-color)]">Loading report content...</p>
                                    </div>`;
            reportIframe.classList.add('hidden');
            reportIframe.srcdoc = '';
            reportIframe.removeEventListener('load', handleIframeLoad);

            fetch(`${WEB_APP_URL}?action=getReportContent&fileId=${fileId}&cachebust=${new Date().getTime()}`)
                .then(async (res) => {
                    if (!res.ok) {
                        let errorBody = await res.text();
                        try {
                             const errJson = JSON.parse(errorBody);
                             throw new Error(errJson.message || `Fetch failed: ${res.status}`);
                         } catch(e) {
                             throw new Error(`Fetch failed: ${res.status} - ${errorBody || res.statusText}`);
                         }
                    }
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                         return res.json();
                    } else {
                         let text = await res.text();
                         throw new Error(`Unexpected response type: ${contentType}. Content: ${text.substring(0, 200)}...`);
                    }
                })
                .then(data => {
                    if (data.status === 'success' && data.html !== undefined) {
                        reportIframe.addEventListener('load', handleIframeLoad, { once: true });
                        reportIframe.srcdoc = data.html;
                    } else {
                        throw new Error(data.message || 'Report HTML content missing in response.');
                    }
                })
                .catch(err => {
                    console.error('Report Load Error:', err);
                    iframeLoader.innerHTML = `<div class="p-4 text-center"><p class="text-red-500 font-bold">Error loading report: ${err.message}</p></div>`;
                    reportIframe.classList.add('hidden');
                    reportIframe.removeEventListener('load', handleIframeLoad);
                });
        }

        // --- Data Loading & Dashboard Building ---
        async function loadData(clearCache = false) {
            setLoading(true);
            showError(null);
            const action = clearCache ? 'clearCacheAndGetData' : 'getDashboardData';
            
            try {
                const response = await fetch(`${WEB_APP_URL}?action=${action}&cachebust=${new Date().getTime()}`);
                if (!response.ok) {
                     const errorText = await response.text();
                     if (errorText.includes("ScriptError")) throw new Error(`Apps Script Error. Check logs.`);
                     if (errorText.includes("Authorization needed")) throw new Error(`Apps Script Authorization Error. Re-deploy.`);
                     throw new Error(`Server error (${response.status}): ${errorText || response.statusText}`);
                }
                const contentType = response.headers.get("content-type");
                 if (!contentType || !contentType.includes("application/json")) {
                    let text = await response.text();
                    throw new Error(`Expected JSON but received ${contentType}. Content: ${text.substring(0, 200)}...`);
                }

                const data = await response.json();
                console.log('Received data:', data);

                if (data.status === 'success') {
                    // *** NEW: The structure now contains the passcode ***
                    bookStructure = data.structure || [];
                    qcSummaries = data.summaries ? new Map(Object.entries(data.summaries)) : new Map();
                    console.log('Processed Book Structure:', bookStructure);
                    buildDashboard();
                    if (clearCache) {
                        console.log("Dashboard refreshed. Logger will get new data on its next load.");
                    }
                } else {
                    throw new Error(data.message || "Script returned error status.");
                }

            } catch (err) {
                 showError(`Failed to load data: ${err.message}.`);
                 dashboardContent.innerHTML = '';
                 console.error("Load Data Error:", err);
            } finally {
                setLoading(false);
                 hideLoader();
            }
        }

        function hideLoader() {
             if (pageLoader && !pageLoader.classList.contains('hidden')) {
                 pageLoader.style.opacity = '0';
                 setTimeout(() => {
                     pageLoader.classList.add('hidden');
                     if (appContainer) appContainer.style.opacity = '1';
                 }, 500);
             } else if (appContainer) {
                 appContainer.style.opacity = '1';
             }
        }

         // --- NEW: Passcode Helper Functions ---
         function showPasscodeModal(bookName, targetId, headerElement) {
            currentBookToUnlock = { bookName, targetId, headerElement };
            passcodeBookName.textContent = `For Book: "${bookName}"`;
            passcodeModalBackdrop.classList.add('visible');
            passcodeInput.focus();
         }
         
         function hidePasscodeModal() {
            passcodeModalBackdrop.classList.remove('visible');
            passcodeError.textContent = '';
            passcodeInput.value = '';
            currentBookToUnlock = null;
            passcodeModal.classList.remove('shake-modal');
         }
         
         function handleSubmitPasscode() {
            const enteredCode = passcodeInput.value;
            if (!currentBookToUnlock || !enteredCode) return;
            
            const bookName = currentBookToUnlock.bookName;
            const bookData = bookStructure.find(b => b.bookName === bookName);
            
            if (bookData && bookData.passcode === enteredCode) {
                // SUCCESS
                sessionStorage.setItem(`unlocked_${bookName}`, 'true');
                const headerElement = currentBookToUnlock.headerElement;
                const contentElement = document.getElementById(currentBookToUnlock.targetId);
                
                // Manually unlock and open
                headerElement.dataset.locked = 'false';
                contentElement.dataset.locked = 'false';
                const lockIcon = headerElement.querySelector('.lock-icon');
                if (lockIcon) {
                    lockIcon.classList.remove('fa-lock');
                    lockIcon.classList.add('fa-lock-open', 'unlocked');
                }
                
                // --- BUG FIX: Manually enable module headers ---
                const moduleHeaders = contentElement.querySelectorAll('.module-header');
                moduleHeaders.forEach(header => {
                    // Remove disabled styles
                    header.style.cursor = 'pointer';
                    header.style.opacity = '1';

                    // Attach the click listener
                    header.addEventListener('click', () => {
                        const targetId = header.getAttribute('data-target');
                        const content = document.getElementById(targetId);
                        const chevron = header.querySelector('.chevron');
                        if (content) {
                            const isOpen = content.classList.contains('open');
                            content.classList.toggle('open', !isOpen);
                            chevron?.classList.toggle('rotate-180', !isOpen);
                        }
                    });
                });
                // --- END BUG FIX ---

                // Manually open accordion
                openAccordion(headerElement, contentElement);
                
                hidePasscodeModal();
            } else {
                // FAILURE
                passcodeError.textContent = 'Incorrect passcode. Please try again.';
                passcodeModal.classList.add('shake-modal');
                passcodeInput.select();
                // Remove shake animation after it finishes
                setTimeout(() => {
                    passcodeModal.classList.remove('shake-modal');
                }, 500);
            }
         }
         
         // Helper to check session storage
         function isBookUnlocked(bookName) {
            return sessionStorage.getItem(`unlocked_${bookName}`) === 'true';
         }

         function buildDashboard() {
            if (bookStructure.length === 0) {
                dashboardContent.innerHTML = `<div class="text-center p-12 text-[var(--text-muted-color)] bg-[var(--sub-box-bg)] rounded-xl">No book structure found. Check Google Sheet tabs or run Apps Script sync if needed.</div>`;
                return;
            }

            let html = '';
            bookStructure.forEach((book, bookIndex) => {
                let moduleHtml = '';
                
                // --- NEW: Check for passcode and unlocked status ---
                const hasPasscode = book.passcode && book.passcode.trim() !== '';
                const unlocked = !hasPasscode || isBookUnlocked(book.bookName);
                const lockedState = hasPasscode && !unlocked;
                
                let lockIconHtml = '';
                if (hasPasscode) {
                    if (unlocked) {
                        lockIconHtml = `<i class="lock-icon unlocked fas fa-lock-open" title="Unlocked for this session"></i>`;
                    } else {
                        lockIconHtml = `<i class="lock-icon fas fa-lock" title="Passcode required"></i>`;
                    }
                }
                // --- End NEW ---

                book.modules.forEach((module, moduleIndex) => {
                    let chapterHtml = '';
                    module.chapters.forEach((chapter) => {
                        const chapterStr = String(chapter || '');
                        const stableId = `${book.bookName}|${module.moduleName}|${chapterStr}`;
                        const summary = qcSummaries.get(stableId);

                        const statusClass = summary ? 'status-done' : 'status-pending';
                        const statusText = summary ? 'Done' : 'Pending';
                        const errors = (summary?.TotalErrors === null || summary?.TotalErrors === undefined || summary?.TotalErrors === '') ? '-' : summary.TotalErrors;
                        const aiPercentValue = summary?.AIPercent;
                        const aiPercent = (aiPercentValue === null || aiPercentValue === undefined || aiPercentValue === '') ? '-' : `${parseFloat(aiPercentValue).toFixed(0)}%`;
                         let lastUpdated = '-';
                         if (summary?.LastUpdated) {
                             try {
                                 const dateObj = new Date(summary.LastUpdated);
                                 if (!isNaN(dateObj.getTime())) {
                                     lastUpdated = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                                 }
                             } catch (e) { /* ignore */ }
                         }

                        const errorClass = summary && errors !== '-' && parseInt(errors) > 0 ? 'text-[var(--bad-text)] font-semibold' : 'text-[var(--text-muted-color)]';
                        const aiClass = summary && aiPercent !== '-' && parseFloat(aiPercent) > 10 ? 'text-[var(--bad-text)] font-semibold' : 'text-[var(--text-muted-color)]';

                        const reportFileID = summary?.ReportFileID;
                        const buttonHtml = (reportFileID && String(reportFileID).trim() !== '') ?
                             `<button data-fileid="${reportFileID}" data-title="${escapeHtml(chapterStr)}" class="view-report-button">View</button>`
                            : `<span class="no-report-span">N/A</span>`;

                        chapterHtml += `
                            <tr>
                                <td class="py-3 px-4 text-sm text-[var(--text-color)] font-medium">${escapeHtml(chapterStr)}</td>
                                <td class="py-3 px-4 text-center"> <span class="status-pill ${statusClass}">${statusText}</span> </td>
                                <td class="py-3 px-4 text-center text-sm ${errorClass}">${errors}</td>
                                <td class="py-3 px-4 text-center text-sm ${aiClass}">${aiPercent}</td>
                                <td class="py-3 px-4 text-center text-xs text-[var(--text-muted-color)]">${lastUpdated}</td>
                                <td class="py-3 px-4 text-center">${buttonHtml}</td>
                            </tr>
                        `;
                    });

                     moduleHtml += `
                        <div class="module-card">
                            <h3 class="module-header" data-target="module-content-${bookIndex}-${moduleIndex}">
                                <span class="module-title">${escapeHtml(module.moduleName)}</span>
                                <svg class="chevron h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /> </svg>
                            </h3>
                            <div id="module-content-${bookIndex}-${moduleIndex}" class="module-content">
                                <table class="chapter-table min-w-full">
                                    <thead>
                                        <tr>
                                            <th class="w-2/5 pl-4">Chapter</th>
                                            <th class="w-[10%] text-center">Status</th>
                                            <th class="w-[10%] text-center">Errors</th>
                                            <th class="w-[10%] text-center">AI %</th>
                                            <th class="w-[15%] text-center">Last QC'd</th>
                                            <th class="w-[15%] text-center pr-4">Report</th>
                                        </tr>
                                    </thead>
                                    <tbody style="background-color: var(--input-bg);">
                                        ${chapterHtml || '<tr><td colspan="6" class="text-center py-4 text-[var(--text-muted-color)]">No chapters found.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div class="book-card">
                        <!-- --- NEW: Added data attributes for locking logic --- -->
                        <h2 class="book-header" 
                            data-target="book-content-${bookIndex}" 
                            data-book-name="${escapeHtml(book.bookName)}"
                            data-passcode-protected="${hasPasscode}"
                            data-locked="${lockedState}">
                            <span class="book-title-wrapper">
                                ${lockIconHtml}
                                <span class="book-title">Book: ${escapeHtml(book.bookName)}</span>
                            </span>
                             <svg class="chevron h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /> </svg>
                        </h2>
                        <div id="book-content-${bookIndex}" class="book-content space-y-4" data-locked="${lockedState}">
                            ${moduleHtml || '<div class="p-4 text-center text-[var(--text-muted-color)]">No modules found for this book.</div>'}
                        </div>
                    </div>
                `;
            });

            dashboardContent.innerHTML = html;
            attachAccordionListeners();
            attachViewReportListeners();
        }

        // --- NEW: Helper to programmatically open an accordion ---
        function openAccordion(header, content) {
            if (!content || !header) return;
            const chevron = header.querySelector('.chevron');
            content.classList.add('open');
            chevron?.classList.add('rotate-180');
        }


        function attachAccordionListeners() {
            dashboardContent.querySelectorAll('.book-header').forEach(header => {
                header.addEventListener('click', () => {
                    const targetId = header.getAttribute('data-target');
                    const content = document.getElementById(targetId);
                    const bookName = header.getAttribute('data-book-name');
                    const isPasscodeProtected = header.getAttribute('data-passcode-protected') === 'true';
                    
                    if (isPasscodeProtected && !isBookUnlocked(bookName)) {
                        // --- NEW: Book is locked, show modal ---
                        console.log(`Book "${bookName}" is locked. Showing modal.`);
                        showPasscodeModal(bookName, targetId, header);
                    } else {
                        // --- Book is not locked or already unlocked, toggle as usual ---
                        const isOpen = content.classList.contains('open');
                        content.classList.toggle('open', !isOpen);
                        header.querySelector('.chevron')?.classList.toggle('rotate-180', !isOpen);
                    }
                });
            });
            
            // --- MODIFICATION 2: Removed auto-open block ---
            // // Auto-open first book and first module if they exist
            // const firstBookContent = dashboardContent.querySelector('.book-content');
            // const firstBookHeader = dashboardContent.querySelector('.book-header');
            // if (firstBookContent) firstBookContent.classList.add('open');
            // if (firstBookHeader) firstBookHeader.querySelector('.chevron')?.classList.add('rotate-180');

            // const firstModuleContent = firstBookContent?.querySelector('.module-content');
            // const firstModuleHeader = firstBookContent?.querySelector('.module-header');
            // if (firstModuleContent) firstModuleContent.classList.add('open');
            // if (firstModuleHeader) firstModuleHeader.querySelector('.chevron')?.classList.add('rotate-180');
            // --- END MODIFICATION ---

            // Module accordion listeners remain unchanged
            dashboardContent.querySelectorAll('.module-header').forEach(header => {
                // --- NEW: Check if parent book is locked ---
                const parentBookContent = header.closest('.book-content');
                const isBookLocked = parentBookContent && parentBookContent.getAttribute('data-locked') === 'true';

                if (isBookLocked) {
                    // Don't attach click listener if book is locked
                    header.style.cursor = 'not-allowed';
                    header.style.opacity = '0.7';
                } else {
                    // Attach listener only if book is unlocked
                    header.addEventListener('click', () => {
                        const targetId = header.getAttribute('data-target');
                        const content = document.getElementById(targetId);
                        const chevron = header.querySelector('.chevron');
                        if (content) {
                            const isOpen = content.classList.contains('open');
                            content.classList.toggle('open', !isOpen);
                            chevron?.classList.toggle('rotate-180', !isOpen);
                        }
                    });
                }
            });
        }


        function attachViewReportListeners() {
            dashboardContent.querySelectorAll('.view-report-button').forEach(button => {
                button.addEventListener('click', () => {
                    // --- NEW: Check if parent book is locked ---
                    const parentBookContent = button.closest('.book-content');
                    if (parentBookContent && parentBookContent.getAttribute('data-locked') === 'true') {
                        console.log("Cannot view report, book is locked.");
                        return; // Do nothing if the book is locked
                    }
                    
                    const fileId = button.getAttribute('data-fileid');
                    const title = button.getAttribute('data-title');
                    if (fileId && fileId !== 'undefined' && fileId !== 'null' && String(fileId).trim() !== '') {
                        showReportPage(fileId, title);
                    } else {
                        console.error("View button clicked, but File ID is missing or invalid:", fileId, "Title:", title);
                        console.error("Cannot view report: File ID is missing. Check the QC_Database sheet.");
                    }
                });
            });
        }

        // --- UI Helpers ---
        function escapeHtml(unsafe) {
             if (typeof unsafe !== 'string') {
                 try { unsafe = String(unsafe); } catch(e) { return ''; }
             }
             return unsafe
                  .replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
         }
        function setLoading(isLoading) {
             refreshButton.disabled = isLoading;
             refreshSpinner.style.display = isLoading ? 'inline-block' : 'none';
             refreshButton.querySelector('i').style.display = isLoading ? 'none' : 'inline-block';
        }
        function showError(message) {
            if (message) {
                errorText.textContent = message;
                errorMessage.style.display = 'block';
            } else {
                errorMessage.style.display = 'none';
            }
        }
    </script>
</body>
</html>
